name: Update CLAUDE.md from Claude Review

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: read

jobs:
  update-claude-md:
    if: github.event.review.user.login == 'claude-code[bot]' || contains(github.event.review.user.login, 'claude')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract review insights
        id: extract
        env:
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          DATE=$(date +%Y-%m-%d)

          if grep -q "## 학습한 내용" CLAUDE.md; then
            if grep -q "### $DATE" CLAUDE.md; then
              echo "" >> CLAUDE.md
              echo "$REVIEW_BODY" >> CLAUDE.md
            else
              sed -i "/## 학습한 내용/a \\\n### $DATE\n" CLAUDE.md
              echo "$REVIEW_BODY" >> CLAUDE.md
            fi
          else
            echo "" >> CLAUDE.md
            echo "---" >> CLAUDE.md
            echo "" >> CLAUDE.md
            echo "## 학습한 내용 (Lessons Learned)" >> CLAUDE.md
            echo "" >> CLAUDE.md
            echo "### $DATE" >> CLAUDE.md
            echo "" >> CLAUDE.md
            echo "$REVIEW_BODY" >> CLAUDE.md
          fi

          echo "updated=true" >> $GITHUB_OUTPUT

      - name: Commit and push
        if: steps.extract.outputs.updated == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CLAUDE.md
          git diff --quiet && git diff --staged --quiet || git commit -m "docs: Auto-add Claude review insights to CLAUDE.md"
          git push
