name: PR - Claude Code Review

on:
  pull_request:
    branches: [dev, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    name: Code Review (GLM-5)
    runs-on: ubuntu-latest
    if: |
      github.actor != 'dependabot[bot]' &&
      !contains(github.event.pull_request.labels.*.name, 'skip-review')

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug Secret
        run: |
          if [ -z "${{ secrets.GLM_API_KEY }}" ]; then
            echo "âŒ GLM_API_KEY is NOT set"
            exit 1
          else
            echo "âœ… GLM_API_KEY is set (length: ${#GLM_KEY})"
          fi
        env:
          GLM_KEY: ${{ secrets.GLM_API_KEY }}

      - name: Get changed files and diff
        id: files
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20 | tr '\n' ', ')
          echo "changed_files=$files" >> $GITHUB_OUTPUT
          echo "Files: $files"

          # Get diff content (limit to 8000 chars to avoid token limits)
          diff_content=$(git diff origin/${{ github.base_ref }}...HEAD | head -500 | cut -c1-8000)
          echo "diff_content<<DIFFEOF" >> $GITHUB_OUTPUT
          echo "$diff_content" >> $GITHUB_OUTPUT
          echo "DIFFEOF" >> $GITHUB_OUTPUT
          echo "Diff length: ${#diff_content} chars"

      - name: Run GLM-5 Code Review
        id: review
        env:
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          FILES: ${{ steps.files.outputs.changed_files }}
          DIFF: ${{ steps.files.outputs.diff_content }}
        run: |
          echo "Calling GLM-5 API..."

          # Create JSON payload with diff content
          payload=$(cat <<JSONEOF
          {
            "model": "glm-5",
            "max_tokens": 3000,
            "messages": [
              {
                "role": "user",
                "content": "ë‹¤ìŒ PRì„ ì½”ë“œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:\n\nì œëª©: $PR_TITLE\n\në³€ê²½ëœ íŒŒì¼: $FILES\n\nì½”ë“œ ë³€ê²½ì‚¬í•­ (diff):\n\`\`\`diff\n$DIFF\n\`\`\`\n\në‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ í•œêµ­ì–´ë¡œ ë¦¬ë·°ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”:\n1. ë³€ê²½ì‚¬í•­ ìš”ì•½\n2. ì½”ë“œ í’ˆì§ˆ ê²€í†  (ë²„ê·¸, ë³´ì•ˆ ë¬¸ì œ, ì„±ëŠ¥ ì´ìŠˆ)\n3. ê°œì„  ì œì•ˆ\n4. AGENTS.mdì— ì¶”ê°€í•˜ë©´ ì¢‹ì„ í”„ë¡œì íŠ¸ ê·œì¹™"
              }
            ]
          }
          JSONEOF
          )

          # Call API
          response=$(curl -s -X POST "https://api.z.ai/api/anthropic/v1/messages" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GLM_API_KEY" \
            -d "$payload" 2>&1)

          echo "API Response:"
          echo "$response"

          # Extract content
          review_content=$(echo "$response" | jq -r '.content[0].text // "Error: No content received"')

          # Save to file
          echo "$review_content" > review_output.md

      - name: Post review comment
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ¤– GLM-5 Code Review" > comment.md
          echo "" >> comment.md
          cat review_output.md >> comment.md
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*This review was generated automatically by GLM-5*" >> comment.md
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md || echo "Failed to post comment"
