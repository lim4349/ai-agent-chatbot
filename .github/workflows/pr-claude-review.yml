name: PR - Claude Code Review + Knowledge Update

on:
  pull_request:
    branches: [dev, main]
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ===========================================
  # PR 리뷰 및 지식 추출
  # ===========================================
  claude-review:
    name: Claude Code Review (GLM-5)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.actor != 'dependabot[bot]' &&
      !contains(github.event.pull_request.labels.*.name, 'skip-review')

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        env:
          ANTHROPIC_BASE_URL: "https://api.z.ai/api/anthropic"
          ANTHROPIC_API_KEY: ${{ secrets.GLM_API_KEY }}
          ANTHROPIC_MODEL: "glm-5"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          cat > review_prompt.txt << 'REVIEWEOF'
          당신은 AI Agent Chatbot 프로젝트의 시니어 코드 리뷰어입니다.

          다음 PR을 리뷰하고 아래 형식으로 분석해주세요:

          ## 1. 변경사항 요약
          - 무엇이 변경되었는지 3줄 이내로 요약

          ## 2. 잠재적 문제점
          - 발견된 버그, 코드 스멜, 안티패턴
          - 각 문제에 대해 파일:라인 위치 명시

          ## 3. 학습 사항 (LESSONS.md 업데이트용)
          이 PR에서 배울 수 있는 교훈:
          - 문제 상황
          - 해결 방법
          - 관련 파일/코드

          ## 4. 권장 수정사항
          - 구체적인 코드 개선 제안

          ## 5. 승인 여부
          - [ ] Approve (수정 없이 승인)
          - [ ] Approve with comments (경미한 수정 필요)
          - [ ] Request changes (필수 수정 필요)

          리뷰 코멘트로 답변을 달아주세요.
          REVIEWEOF

          claude -p "$(cat review_prompt.txt)" --allowedTools="Bash,Read,Edit,Glob,Grep" > review_output.md

          # PR에 리뷰 코멘트로 게시
          gh pr comment $PR_NUMBER --body-file review_output.md || true
        working-directory: ${{ github.workspace }}

  # ===========================================
  # PR 병합 시 LESSONS.md 자동 업데이트
  # ===========================================
  update-knowledge:
    name: Update LESSONS.md
    runs-on: ubuntu-latest
    # PR이 main에 병합되었을 때만 실행
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Extract lessons and update LESSONS.md
        env:
          ANTHROPIC_BASE_URL: "https://api.z.ai/api/anthropic"
          ANTHROPIC_API_KEY: ${{ secrets.GLM_API_KEY }}
          ANTHROPIC_MODEL: "glm-5"
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          COMMIT_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          # PR의 변경사항 가져오기
          git log --oneline -10 > recent_commits.txt
          git diff HEAD~1 --name-only > changed_files.txt

          # Claude에게 LESSONS.md 업데이트 요청
          cat > lessons_prompt.txt << 'LESSONSEOF'
          당신은 프로젝트 지식 관리 전문가입니다.

          현재 PR이 main 브랜치에 병합되었습니다. 다음 정보를 바탕으로 LESSONS.md 파일을 업데이트해주세요:

          PR 정보:
          - 번호: #${{ env.PR_NUMBER }}
          - 제목: ${{ env.PR_TITLE }}
          - 본문: ${{ env.PR_BODY }}
          - 머지 커밋: ${{ env.COMMIT_SHA }}

          최근 커밋:
          $(cat recent_commits.txt)

          변경된 파일:
          $(cat changed_files.txt)

          다음 규칙을 따라주세요:
          1. 새로운 문제/해결책이 있다면 적절한 섹션에 추가
          2. 중복 내용은 추가하지 않음
          3. "자동 업데이트 로그" 테이블에 새 행 추가
          4. 마지막 업데이트 날짜를 오늘로 변경

          LESSONS.md 파일을 직접 수정하세요.
          LESSONSEOF

          claude -p "$(cat lessons_prompt.txt)" --allowedTools="Read,Edit" || echo "Claude update skipped"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git diff --quiet LESSONS.md; then
            echo "No changes to LESSONS.md"
            exit 0
          fi

          git add LESSONS.md
          git commit -m "docs: Update LESSONS.md from PR #${{ github.event.pull_request.number }}

          - Auto-generated by Claude Code Review (GLM-5)
          - PR: ${{ github.event.pull_request.title }}

          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
