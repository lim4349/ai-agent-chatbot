name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-assistant:
    name: Claude Code (GLM-5)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number from issue_comment or pull_request_review_comment
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_NUMBER=${{ github.event.issue.number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi

          COMMENT="${{ github.event.comment.body }}"
          REQUEST="${COMMENT//@claude/}"
          REQUEST="${REQUEST#"${REQUEST%%[![:space:]]*}"}"

          if [ -z "$REQUEST" ]; then
            REQUEST="review this PR and suggest improvements"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          {
            echo "request<<REQEOF"
            echo "$REQUEST"
            echo "REQEOF"
          } >> $GITHUB_OUTPUT

          # Get PR diff
          gh pr diff $PR_NUMBER > pr_diff.txt 2>/dev/null || echo "Could not fetch diff"

          # Get PR title
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q '.title')
          echo "pr_title<<TITLEEOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "TITLEEOF" >> $GITHUB_OUTPUT

      - name: Run GLM-5 Assistant
        id: glm
        env:
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
          PR_TITLE: ${{ steps.context.outputs.pr_title }}
          REQUEST: ${{ steps.context.outputs.request }}
        run: |
          DIFF=$(cat pr_diff.txt 2>/dev/null | head -300 | cut -c1-6000)

          echo "다음 요청을 처리해주세요: $REQUEST" > prompt.txt
          echo "" >> prompt.txt
          echo "PR 제목: $PR_TITLE" >> prompt.txt
          echo "" >> prompt.txt
          echo "코드 변경사항:" >> prompt.txt
          echo '```diff' >> prompt.txt
          echo "$DIFF" >> prompt.txt
          echo '```' >> prompt.txt
          echo "" >> prompt.txt
          echo "한국어로 답변하고, 구체적인 개선 제안을 포함해주세요." >> prompt.txt

          payload=$(jq -Rs '{model: "glm-5", max_tokens: 4000, messages: [{role: "user", content: .}]}' prompt.txt)

          response=$(curl -s -X POST "https://api.z.ai/api/anthropic/v1/messages" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GLM_API_KEY" \
            -d "$payload" 2>&1)

          echo "API Response: $response"

          if echo "$response" | jq -e '.content[0].text' > /dev/null 2>&1; then
            content=$(echo "$response" | jq -r '.content[0].text')
          elif echo "$response" | jq -e '.error' > /dev/null 2>&1; then
            error_msg=$(echo "$response" | jq -r '.error.message // .error.type // "Unknown error"')
            content="API Error: $error_msg"
          else
            content="Error: Unexpected response format"
          fi
          echo "$content" > response.md

          if echo "$REQUEST" | grep -qi "update.*claude.md\|기억\|learn\|save\|저장"; then
            echo "should_update_claude_md=true" >> $GITHUB_OUTPUT
            DATE=$(date +%Y-%m-%d)
            echo "" > claude_md_update.txt
            echo "### $DATE (PR #$PR_NUMBER)" >> claude_md_update.txt
            echo "" >> claude_md_update.txt
            echo "$content" >> claude_md_update.txt
          else
            echo "should_update_claude_md=false" >> $GITHUB_OUTPUT
          fi

      - name: Post response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
        run: |
          echo "## Claude (GLM-5)" > comment.md
          echo "" >> comment.md
          cat response.md >> comment.md
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*Triggered by @claude*" >> comment.md

          gh pr comment $PR_NUMBER --body-file comment.md

      - name: Update CLAUDE.md if requested
        if: steps.glm.outputs.should_update_claude_md == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Claude Code[bot]"
          git config user.email "claude-code[bot]@anthropic.com"

          if grep -q "## 학습한 내용" CLAUDE.md; then
            cat claude_md_update.txt >> CLAUDE.md
          else
            echo "" >> CLAUDE.md
            echo "---" >> CLAUDE.md
            echo "" >> CLAUDE.md
            echo "## 학습한 내용 (Lessons Learned)" >> CLAUDE.md
            cat claude_md_update.txt >> CLAUDE.md
          fi

          git add CLAUDE.md
          git commit -m "docs: Add Claude review insights to CLAUDE.md [skip ci]"
          git push
