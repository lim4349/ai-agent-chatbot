name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-assistant:
    name: Claude Code (GLM-5)
    runs-on: ubuntu-latest
    # Trigger on @claude mention
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          COMMENT="${{ github.event.comment.body }}"

          # Remove @claude from comment to get the actual request
          REQUEST="${COMMENT//@claude/}"
          REQUEST="${REQUEST#"${REQUEST%%[![:space:]]*}"}"  # trim leading whitespace

          # If empty, default to "review this PR"
          if [ -z "$REQUEST" ]; then
            REQUEST="review this PR and suggest improvements"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          # Handle multiline request with heredoc delimiter
          {
            echo "request<<REQEOF"
            echo "$REQUEST"
            echo "REQEOF"
          } >> $GITHUB_OUTPUT

          # Get PR diff
          gh pr diff $PR_NUMBER > pr_diff.txt 2>/dev/null || echo "Could not fetch diff"

          # Get PR info
          PR_TITLE=$(gh pr view $PR_NUMBER --json title -q '.title')
          echo "pr_title<<TITLEEOF" >> $GITHUB_OUTPUT
          echo "$PR_TITLE" >> $GITHUB_OUTPUT
          echo "TITLEEOF" >> $GITHUB_OUTPUT

      - name: Run GLM-5 Assistant
        id: glm
        env:
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
          PR_TITLE: ${{ steps.context.outputs.pr_title }}
          REQUEST: ${{ steps.context.outputs.request }}
        run: |
          # Read diff (limit size)
          DIFF=$(cat pr_diff.txt 2>/dev/null | head -300 | cut -c1-6000)

          # Write prompt to file to avoid shell escaping issues
          cat > prompt.txt << 'PROMPTEOF'
          ë‹¤ìŒ ìš”ì²­ì„ ì²˜ë¦¬í•´ì£¼ì„¸ìš”: REQUEST_PLACEHOLDER

          PR ì œëª©: TITLE_PLACEHOLDER

          ì½”ë“œ ë³€ê²½ì‚¬í•­:
          ```diff
          DIFF_PLACEHOLDER
          ```

          í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ê³ , êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆì„ í¬í•¨í•´ì£¼ì„¸ìš”.
          PROMPTEOF

          # Replace placeholders (using | as delimiter to avoid conflicts with diff content)
          sed -i "s|REQUEST_PLACEHOLDER|${REQUEST}|g" prompt.txt
          sed -i "s|TITLE_PLACEHOLDER|${PR_TITLE}|g" prompt.txt
          # For DIFF, need to handle special characters - use awk instead
          awk -v diff="$DIFF" '{gsub(/DIFF_PLACEHOLDER/, diff); print}' prompt.txt > prompt_tmp.txt && mv prompt_tmp.txt prompt.txt

          # Create JSON payload using jq reading from file
          payload=$(jq -Rs '{
            model: "glm-5",
            max_tokens: 4000,
            messages: [
              {
                role: "user",
                content: .
              }
            ]
          }' prompt.txt)

          # Call GLM API
          response=$(curl -s -X POST "https://api.z.ai/api/anthropic/v1/messages" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GLM_API_KEY" \
            -d "$payload" 2>&1)

          echo "API Response:"
          echo "$response"

          # Extract content with error handling
          if echo "$response" | jq -e '.content[0].text' > /dev/null 2>&1; then
            content=$(echo "$response" | jq -r '.content[0].text')
          elif echo "$response" | jq -e '.error' > /dev/null 2>&1; then
            error_msg=$(echo "$response" | jq -r '.error.message // .error.type // "Unknown error"')
            content="âŒ API Error: $error_msg"
          else
            content="âŒ Error: Unexpected response format"
          fi
          echo "$content" > response.md

          # Check if we should update CLAUDE.md
          if echo "$REQUEST" | grep -qi "update.*claude.md\|lessons\|learn"; then
            echo "should_update_claude_md=true" >> $GITHUB_OUTPUT
          else
            echo "should_update_claude_md=false" >> $GITHUB_OUTPUT
          fi

      - name: Post response
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
        run: |
          echo "## ðŸ¤– Claude (GLM-5)" > comment.md
          echo "" >> comment.md
          cat response.md >> comment.md
          echo "" >> comment.md
          echo "---" >> comment.md
          echo "*Triggered by \`@claude\` â€¢ Powered by GLM-5*" >> comment.md

          gh pr comment $PR_NUMBER --body-file comment.md

      - name: Update CLAUDE.md if requested
        if: steps.glm.outputs.should_update_claude_md == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Claude Code[bot]"
          git config user.email "claude-code[bot]@anthropic.com"

          # Append to CLAUDE.md
          echo "" >> CLAUDE.md
          cat response.md >> CLAUDE.md

          git add CLAUDE.md
          git commit -m "claude: Add lessons learned from PR [skip ci]"
          git push
