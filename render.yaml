# Render.com Infrastructure as Code
# Free Tier Configuration
# Usage: render blueprint apply render.yaml
#
# This blueprint creates:
#   1. ai-agent-backend (FastAPI web service)
#
# External Services (set up separately):
#   - Pinecone (Vector DB): https://app.pinecone.io
#   - Upstash Redis (Session Memory): https://upstash.com
#
# After initial creation, GitHub Actions will handle deployments
# via .github/workflows/ci-cd.yml

services:
  - type: web
    name: ai-agent-backend
    runtime: docker
    repo: https://github.com/${GITHUB_REPOSITORY}
    branch: main
    rootDir: backend
    dockerContext: .
    dockerfilePath: Dockerfile
    envVars:
      - key: PYTHON_VERSION
        value: 3.12.0
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: LLM_PROVIDER
        value: openai
      - key: LLM_MODEL
        value: google/gemini-2.0-flash-001
      - key: LLM_BASE_URL
        value: https://openrouter.ai/api/v1
      # Secrets - Set these in Render Dashboard
      - key: LLM_OPENAI_API_KEY
        sync: false  # OpenRouter API key (sk-or-v1-...)
      - key: TAVILY_API_KEY
        sync: false
      # Memory configuration (Upstash Redis)
      - key: MEMORY_BACKEND
        value: redis
      - key: MEMORY_REDIS_URL
        sync: false  # Set from Upstash Dashboard: rediss://default:<password>@<endpoint>.upstash.io:6379
      - key: MEMORY_TTL_SECONDS
        value: "3600"
      # RAG configuration (Pinecone)
      - key: RAG_CHUNK_SIZE
        value: "1000"
      - key: RAG_CHUNK_OVERLAP
        value: "200"
      - key: RAG_COLLECTION_NAME
        value: documents
      - key: RAG_EMBEDDING_PROVIDER
        value: pinecone
      - key: RAG_EMBEDDING_MODEL
        value: multilingual-e5-large
      # Pinecone configuration - Set in Render Dashboard
      - key: RAG_PINECONE_API_KEY
        sync: false
      - key: RAG_PINECONE_INDEX_NAME
        value: documents
      - key: RAG_PINECONE_NAMESPACE
        value: default
      # Code execution
      - key: CODE_EXECUTION_ENABLED
        value: "true"
      - key: CODE_EXECUTION_TIMEOUT
        value: "30"
    healthCheckPath: /api/v1/health
    autoDeploy: false  # Controlled by GitHub Actions
    port: 8000
    plan: free

# External Services Setup:
#
# 1. Pinecone (Vector DB for RAG):
#    - Create account: https://app.pinecone.io
#    - Create index: name=documents, dimensions=1024, metric=cosine
#    - Copy API Key to RAG_PINECONE_API_KEY
#
# 2. Upstash Redis (Session Memory):
#    - Create account: https://upstash.com
#    - Create Redis database (free tier: 10,000 requests/day)
#    - Copy "UPSTASH_REDIS_REST_URL" or use "Rediss URL" format:
#      rediss://default:<password>@<endpoint>.upstash.io:6379
#    - Set to MEMORY_REDIS_URL in Render Dashboard
